<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç°¡å–®é­”è—¥åº—ç¶“ç‡ŸéŠæˆ²</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;700&display=swap');
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Noto Sans TC', sans-serif;
    background: #0f0b09 url('https://raw.githubusercontent.com/tcchoy/potion_shop_adventure_story/refs/heads/main/Whisperwind%20Woodland.png') center/cover no-repeat fixed;
    color: #4e342e;
    min-height: 100vh;
    padding: 20px;
    position: relative;
  }
  body::before {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(15, 11, 9, 0.7);
    pointer-events: none;
  }
  .container { max-width: 1400px; margin: 0 auto; position: relative; z-index: 1; }
  header {
    text-align: center; margin-bottom: 20px; background: rgba(255,255,255,0.95);
    border-radius: 1.5rem; padding: 20px 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    border: 3px solid #ffcc80;
  }
  h1 { font-size: 2.8rem; color: #85522d; text-shadow: 2px 2px 5px rgba(0,0,0,0.1); font-weight: 700; }
  .game-area {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    min-height: 70vh;
  }
  @media (max-width: 1024px) {
    .game-area { grid-template-columns: 1fr; }
  }
  .panel {
    background: rgba(255,255,255,0.9); border-radius: 1.5rem; padding: 25px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2); backdrop-filter: blur(4px);
    border: 1px solid #ffccbc;
  }
  .panel h2 {
    font-size: 1.8em; color: #6d4c41; margin-bottom: 15px;
    text-align: center; border-bottom: 2px solid #ffab91; padding-bottom: 8px;
    font-weight: 700;
  }
  button {
    background: linear-gradient(to bottom, #ffcc80, #ff9800); border: none;
    padding: 10px 18px; border-radius: 9999px; font-weight: bold; cursor: pointer;
    box-shadow: 0 4px 10px rgba(255,152,0,0.4); transition: all 0.2s ease-in-out;
    margin: 4px; color: #4e342e;
  }
  button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(255,152,0,0.6); background: linear-gradient(to bottom, #ffdb99, #ffb74d); }
  button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
  
  #log {
    height: 350px; overflow-y: auto; background: #fffdfa;
    padding: 15px; border-radius: 15px; line-height: 1.6;
    border: 2px dashed #ffab91; color: #4e342e;
    font-size: 0.95rem;
    display: flex; /* For CR-8: New flex container */
    flex-direction: column-reverse; /* For CR-8: Puts new logs at the top */
  }
  .log-entry { margin-bottom: 8px; border-bottom: 1px dotted #ffccbc; padding-bottom: 5px; opacity: 0; animation: fadein 0.8s forwards; }
  .log-entry.success { color: #2e7d32; font-weight: bold; }
  .log-entry.fail { color: #d32f2f; }
  .log-entry.event { color: #9c27b0; font-style: italic; font-weight: 700; }
  @keyframes fadein { from {opacity:0; transform:translateY(5px);} to {opacity:1; transform:none;} }
  
  .inventory, .potions-list {
    display: grid; gap: 8px; margin-top: 10px;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  }
  .item {
    background: #e1f5fe; padding: 8px; border-radius: 8px;
    text-align: center; font-size: 0.85rem; border: 1px solid #90caf9;
    cursor: default;
    transition: background 0.1s;
    position: relative; /* For CR-5 */
  }
  .item-content {
      display: flex; justify-content: center; align-items: center;
      flex-direction: column;
      min-height: 50px;
  }
  .item-info {
      font-weight: 500; margin-bottom: 5px;
      cursor: pointer;
   
				 
																		
  }
  /* CR-5: Optimized Discard Button Style */
  .action-btn.discard { 
      position: absolute; 
      top: -5px; 
      right: -5px; 
      padding: 0;
      width: 20px; 
      height: 20px; 
      line-height: 1; 
      font-size: 1rem; 
      background-color: #f44336; 
      color: white; 
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2); 
      z-index: 10;
  }
																  
  
  .potion { 
      background: #fce4ec; 
      border: 1px solid #f48fb1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      padding: 10px 8px;
  }
  .potion-info {
      font-size: 0.9em;
      font-weight: bold;
      margin-bottom: 8px;
  }
  .potion-sell-btn {
      background: #4caf50; 
      color: white;
      padding: 5px 10px;
      border-radius: 9999px;
      font-size: 0.75rem;
      cursor: pointer;
  }
  .potion-sell-btn:hover { background: #66bb6a; }

  #cauldron-area {
    min-height: 150px; background: #4e342e; border-radius: 1rem;
    padding: 15px; margin: 15px 0; border: 4px solid #795548;
    box-shadow: inset 0 0 15px rgba(0,0,0,0.5);
    display: flex; justify-content: center; align-items: center; flex-wrap: wrap;
    gap: 10px;
  }
  .cauldron-item {
    background: #a1887f; color: white; padding: 5px 10px;
    border-radius: 5px; font-size: 0.9em; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  }
  .gold { color: #ff8f00; font-weight: 900; }
  .recipe-list { font-size: 0.85em; line-height: 1.6; max-height: 32	0px; overflow-y: auto; color: #4e342e; }
  .recipe-entry {
      display: flex; justify-content: space-between; align-items: center;
      padding: 3px 0;
      border-bottom: 1px dotted #ffccbc;
  }
  .recipe-text { flex-grow: 1; }
  .recipe-action button { 
      padding: 2px 8px; font-size: 0.75rem; margin: 0; 
      border-radius: 9999px; 
      background: #795548; color: white;
  }
  .recipe-action button:hover { background: #5d4037; }
  .recipe-unknown { color: #757575; font-style: italic; }
  .recipe-known { color: #4e342e; font-weight: 500; }

  /* New Styling for Quest */
  #quest {
    background: #fff3e0; border: 2px solid #ffcc80; padding: 15px;
    border-radius: 12px; margin-bottom: 15px;
  }
  #quest p { margin-bottom: 10px; color: #4e342e; }
  #quest strong { color: #8d6e63; font-size: 1.1em; }
  
  /* Custom Confirmation Modal Styling */
  #confirmModal {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.7); display: none; z-index: 1000;
    justify-content: center; align-items: center;
  }
  .modal-content {
    background: white; padding: 30px; border-radius: 1rem;
    width: 90%; max-width: 400px; text-align: center;
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
  }
  
  .tier-display {
      font-size: 0.7rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 5px;
      margin-left: 5px;
      display: inline-block;
  }
  .tier-1 { background-color: #a5d6a7; color: #1b5e20; }
  .tier-2 { background-color: #ffcc80; color: #e65100; }
  .tier-3 { background-color: #f48fb1; color: #880e4f; }
  
  /* CR-7: Element-based colors for inventory sorting visual cue */
  .element-Wind { background-color: #e3f2fd; border-color: #90caf9; }
  .element-Fire { background-color: #ffebee; border-color: #ef9a9a; }
  .element-Water { background-color: #e0f7fa; border-color: #80deea; }
  .element-Earth { background-color: #fbe9e7; border-color: #ffab91; }

</style>
</head>
<body>

<div class="container">
  <header>
    <h1>éŠé‡‘åº—çš„ç™¼ç¾ä¹‹æ—…</h1>
    <p class="text-sm text-gray-600 mb-3">æ–‡å­—é­”è—¥åº—å„ªåŒ–ç‰ˆï¼šæ¢ç´¢ã€å¯¦é©—ã€ç¶“ç‡Ÿ</p>
    <div class="flex flex-wrap justify-center items-center gap-4 text-lg">
      <span class="p-2 bg-yellow-100 rounded-full shadow-md">ğŸ’° é‡‘å¹£ï¼š<span id="gold" class="gold">50</span> G</span>
      <span class="p-2 bg-blue-100 rounded-full shadow-md">ğŸ“… æ—¥æ•¸ï¼š<span id="day">1</span></span>
      <span class="p-2 bg-purple-100 rounded-full shadow-md">âœ¨ è²æœ›ï¼š<span id="fame">0</span> âœ¦</span>
      <span class="p-2 bg-red-100 rounded-full shadow-md">ğŸ¥µ ç–²å‹ï¼š<span id="fatigue">0</span>/<span id="maxFatigue">20</span></span>
    </div>
    <div class="mt-4">
      <button onclick="saveGame()">ğŸ’¾ åŒ¯å‡ºå­˜æª”</button>
      <button onclick="loadGame()">ğŸ“‚ è®€å–å­˜æª”</button>
      <button onclick="openClearSaveModal()">ğŸ—‘ï¸ æ¸…é™¤é€²åº¦</button>
      <span id="saveStatus" class="text-sm text-green-600 ml-4" style="display:none;">å·²è‡ªå‹•å­˜æª”ï¼</span>
    </div>
  </header>

  <div class="game-area">
							   
    <div class="panel">
												 
      <h2>é‡å¤–æ¡é›† âœ¿ (ç–²å‹ +1)</h2> <p class="text-gray-700 mb-4">ä»Šå¤©è¦å»å“ªè£¡æ¢éšªå‘¢ï¼Ÿ</p>
									   
      <div class="flex flex-wrap gap-2 mb-4">
        <button onclick="explore('wind')" id="btn-wind">ğŸŒ¬ï¸ ç–¾é¢¨è‰åŸ</button>
        <button onclick="explore('fire')" id="btn-fire">ğŸ”¥ çƒˆç„°ç«å±±</button>
        <button onclick="explore('water')" id="btn-water">ğŸ’§ æ·±æµ·æ¹–æ³Š</button>
        <button onclick="explore('earth')" id="btn-earth">ğŸŒ å¤§åœ°æ£®æ—</button>
      </div>
      
      <div id="explore-info" class="text-sm text-gray-600 mb-2"></div>
      
      <h3>èƒŒåŒ…ï¼ˆ<span id="invCount">0</span>/<span id="maxInv">30</span>ï¼‰<span class="text-xs text-red-500" id="fatigueWarning" style="display:none;">ï¼ˆé«˜ç–²å‹ï¼Œæœ‰é¢¨éšªï¼ï¼‰</span></h3>
      <p class="text-xs text-gray-500 mb-2">é»æ“Šç´ ææ”¾å…¥é‹çˆï¼Œæˆ–é»æ“Šå³ä¸Šæ–¹æ¸›è™Ÿä¸Ÿæ£„ç´ æã€‚</p>
      <div id="inventory" class="inventory"></div>
      
      <div class="mt-4 border-t pt-3">
          <button id="upgradeInvBtn" onclick="upgradeInventory()" class="w-full bg-blue-300 hover:bg-blue-400">
              ğŸ’ æ“´å±•èƒŒåŒ…è‡³ <span id="nextMaxInv">40</span> (è²»ç”¨ï¼š<span id="upgradeCost">100</span> G)
          </button>
      </div>
    </div>

							   
    <div class="panel">
      <h2>éŠé‡‘é‹çˆ âœ¨ (éœ€ 2 ç¨®ç´ æ)</h2>
      <div id="cauldron-area">
											   
        <span class="text-gray-400 text-lg" id="cauldronPlaceholder">é‹çˆç©ºç©ºå¦‚ä¹Ÿ...</span>
      </div>
      <div class="flex flex-wrap gap-2 justify-center mb-4">
        <button onclick="brew()" class="bg-red-300 hover:bg-red-400">ğŸ”¥ é–‹å§‹ç†¬ç…®</button>
        <button onclick="clearCauldron()" class="bg-gray-300 hover:bg-gray-400">æ¸…ç©ºé‹å­ (è¿”é‚„ç´ æ)</button>
      </div>
      
													  
      <h3>å·²çŸ¥é…æ–¹ (éœ€æˆåŠŸç†¬ç…®å¾Œè§£é–, å¯ä»¥é»æ“Šåˆæˆ)</h3> <div id="recipes" class="recipe-list"></div>
      
      <h3>è—¥æ°´åº«å­˜</h3>
      <div id="potionsList" class="potions-list"></div>
    </div>

										
    <div class="panel">
      <h2>ğŸ”” ä»Šæ—¥å§”è¨—</h2>
      <div id="quest"></div>
      <button onclick="nextDay()" class="w-full mt-4 bg-green-300 hover:bg-green-400">ğŸŒ… è¿æ¥æ–°çš„ä¸€å¤© (é‡ç½®ç–²å‹)</button>
      
      <h2>ğŸ“œ å†’éšªæ—¥èªŒ</h2>
      <div id="log"></div>
    </div>
  </div>
</div>

													   
<div id="confirmModal">
  <div class="modal-content">
    <h3 class="text-2xl font-bold text-red-600 mb-4">âš ï¸ æœ€çµ‚è­¦å‘Š âš ï¸</h3>
    <p class="mb-6 text-gray-700">çœŸçš„è¦**æ¸…é™¤æ‰€æœ‰é€²åº¦**ï¼Œå›åˆ°æœ€åˆå—ï¼Ÿé€™å°‡**ç„¡æ³•å¾©åŸ**ã€‚</p>
    <div class="flex justify-center gap-4">
      <button onclick="clearSaveConfirmed(true)" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full">
        ğŸ—‘ï¸ ç¢ºèªæ¸…é™¤
      </button>
      <button onclick="clearSaveConfirmed(false)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full">
        å–æ¶ˆ
      </button>
    </div>
  </div>
</div>


<script>
// --- æ•¸æ“šçµæ§‹é‡æ§‹ï¼šçµ±ä¸€æ•¸æ“šæº (ITEM_DATA) (CR-4 + BUG-4 Fix)---
const ITEM_DATA = {
  // --- Materials (Element Themed) ---
  
  // WIND ğŸŒ¬ï¸ (ç–¾é¢¨è‰åŸ)
  "é¢¨è¡Œè‰": { tier: 1, type: 'Herb', basePrice: 10, icon: 'ğŸƒ', story: "éš¨è‘—é¢¨è¼•è¼•é£„å‹•çš„è‰ï¼Œè¼•ç›ˆç¿ ç¶ ã€‚", element: 'Wind', sortOrder: 1 },
  "å¹¸é‹çµ¨æ¯›": { tier: 1, type: 'Animal', basePrice: 25, icon: 'ğŸ•Šï¸', story: "é›ªç™½çš„çµ¨æ¯›ï¼Œå‚³èªªèƒ½å¸¶ä¾†å¥½é‹ã€‚", element: 'Wind', sortOrder: 2 },
  "å½©è™¹èŠ±": { tier: 2, type: 'Flower', basePrice: 35, icon: 'ğŸŒˆ', story: "å½©è™¹èŠ±çš„èŠ±ç“£æœƒéš¨å…‰ç·šå’Œç”Ÿé•·çš„åœ°æ–¹æ”¹è®Šè‰²å½©ã€‚", element: 'Wind', sortOrder: 4 },
  "ç¨è§’ç¸æ¯›": { tier: 3, type: 'Animal', basePrice: 30, icon: 'ğŸ¦„', story: "ç¨è§’ç¸æŸ”è»Ÿç´°ç·»çš„æ¯›é«®ï¼Œå¦‚å¤¢ä¼¼å¹»ã€‚", element: 'Wind', sortOrder: 3 },

  // FIRE ğŸ”¥ (çƒˆç„°ç«å±±)
  "ç«ç´…æ™¶": { tier: 1, type: 'Mineral', basePrice: 10, icon: 'ğŸ”¥', story: "åœ¨æš—è™•ç™¼å‡ºå¼·çƒˆå…‰èŠ’ï¼Œåƒè—è‘—å°ç«ç„°ã€‚", element: 'Fire', sortOrder: 5 },
  "æ¯’è›‡ç‰™": { tier: 1, type: 'Monster', basePrice: 15, icon: 'ğŸ', story: "å¾å²©ç¸«ä¸­æ‰¾åˆ°è„«è½çš„æ¯’ç‰™ï¼Œè‡ªå¸¶æ¯’ç´ ã€‚", element: 'Fire', sortOrder: 6 },
  "ç´…ç‚èŠ±ç“£": { tier: 2, type: 'Flower', basePrice: 20, icon: 'ğŸŒ¸', story: "èµ¤ç´…çš„èŠ±ç“£æ•£ç™¼å¾®å¾®æš–æ„ã€‚", element: 'Fire', sortOrder: 7 },
  "ç«èœ¥èœ´å°¾": { tier: 3, type: 'Monster', basePrice: 30, icon: 'ğŸ¦', story: "å°¾ç«¯ä»æ®˜ç•™å¾®å¼±ç†±åº¦ï¼Œæ¥µå…·åƒ¹å€¼ã€‚", element: 'Fire', sortOrder: 8 }, // BUG-4 Material

  // WATER ğŸ’§ (æ·±æµ·æ¹–æ³Š)
  "å†°é›ªè˜‘è‡": { tier: 1, type: 'Fungus', basePrice: 10, icon: 'ğŸ„', story: "å†’å‡ºæ·¡æ·¡å…‰æšˆï¼Œæ¹–ç•”çš„åŸºç¤ç´ æã€‚", element: 'Water', sortOrder: 9 },
  "æ°´è“®": { tier: 1, type: 'Flower', basePrice: 15, icon: 'ğŸ’§', story: "æ•£ç™¼æ¸…æ–°çš„é¦™æ°£ï¼Œåƒæ¹–é¢æ¸…æ™¨çš„ç©ºæ°£ã€‚", element: 'Water', sortOrder: 10 },
  "æ˜Ÿéœ²æ°´": { tier: 2, type: 'Liquid', basePrice: 20, icon: 'âœ¨', story: "æ˜ å‡ºå¾®å°æ˜Ÿå…‰ï¼Œåƒè£è‘—ä¸€ç‰‡å¤œç©ºã€‚", element: 'Water', sortOrder: 11 },
  "äººé­šé±—ç‰‡": { tier: 3, type: 'Monster', basePrice: 30, icon: 'ğŸ§œâ€â™€ï¸', story: "åœ¨é™½å…‰ä¸‹é–ƒé–ƒç™¼äº®ï¼Œæ¥µé›£ç²å¾—ã€‚", element: 'Water', sortOrder: 12 },

  // EARTH ğŸŒ (å¤§åœ°æ£®æ—)
  "æœˆå…‰è‰": { tier: 1, type: 'Herb', basePrice: 10, icon: 'ğŸŒ™', story: "è‘‰é¢ä¸Šæœ‰éŠ€ç™½è‰²çš„å…‰ç—•ï¼Œå¸¸è¦‹æ–¼æ£®æ—ã€‚", element: 'Earth', sortOrder: 13 },
  "ç²—ç³™ç¤¦çŸ³": { tier: 1, type: 'Mineral', basePrice: 20, icon: 'ğŸ’', story: "å¾åœ°åº•æŒ–å‡ºçš„åŸºç¤ç¤¦çŸ³ã€‚", element: 'Earth', sortOrder: 14 },
  "é¾æ¯è‰": { tier: 2, type: 'Herb', basePrice: 40, icon: 'ğŸ²', story: "æ•£å‡ºç´°ç´°ç…™éœ§ï¼Œåƒå°é¾çš„å‘¼å¸ã€‚", element: 'Earth', sortOrder: 15 },
  "è¢å…‰çŸ³": { tier: 3, type: 'Mineral', basePrice: 30, icon: 'ğŸ’¡', story: "æŸ”å…‰ç…§äº®æŒ‡å°–ï¼Œå……æ»¿æš–æ„ï¼Œååˆ†ç¨€æœ‰ã€‚", element: 'Earth', sortOrder: 16 },


  // --- Potions (CR-4: New Recipes, T1 uses same location materials) ---
  // T1 Potions (Base T1 materials from same location)
  "ä½éšæ²»ç™‚è—¥æ°´": { tier: 1, type: 'Potion', basePrice: 80, ingredients: ["é¢¨è¡Œè‰", "å†°é›ªè˜‘è‡"], brewText: "é›–ç„¶åªæ˜¯ä½éšæ²»ç™‚è—¥æ°´ï¼Œå¸Œæœ›èƒ½å¹«åŠ©åˆ°æœ‰éœ€è¦çš„äººå§!" }, // Wind + Water T1
  "ä½éšæ¯’è—¥": { tier: 1, type: 'Potion', basePrice: 100, ingredients: ["æ¯’è›‡ç‰™", "æœˆå…‰è‰"], brewText: "ç¶ è‰²æ¯’éœ§ç€°æ¼«ï¼Œé€£ç“¶è“‹éƒ½å±å±ä½œéŸ¿â€¦å°å¿ƒï¼" }, 
  // Fire + Earth T1

  // T2 Potions (Require T1 + T2 or two T2 materials)
  "é€Ÿåº¦è—¥æ°´": { tier: 2, type: 'Potion', basePrice: 180, ingredients: ["é¢¨è¡Œè‰", "å¹¸é‹çµ¨æ¯›"], brewText: "æ·¡ç¶ è‰²çš„è—¥åŠ‘æ´‹æº¢é¢¨å…ƒç´ ï¼Œå–äº†è…³æ­¥æœƒè®Šå¾—é£›å¿«ï¼" }, // T1 Wind + T2 Wind
  "ç«ç„°è—¥æ°´": { tier: 2, type: 'Potion', basePrice: 150, ingredients: ["ç«ç´…æ™¶", "ç´…ç‚èŠ±ç“£"], brewText: "ç«ç„°åœ¨ç“¶ä¸­è·³èˆï¼Œåƒé—œè‘—ä¸€éš»å°ç«é¾ï¼" }, // T1 Fire + T2 Fire
  "åŠ›é‡è—¥æ°´": { tier: 2, type: 'Potion', basePrice: 220, ingredients: ["ç´…ç‚èŠ±ç“£", "ç²—ç³™ç¤¦çŸ³"], brewText: "è‚Œè‚‰é¼“èµ·çš„ç´…è‰²å…‰èŠ’ï¼ŒåŠ›é‡çˆ†ç™¼å•¦ï¼" }, // T2 Fire + T2 Earth
  "å¹¸é‹è—¥æ°´": { tier: 2, type: 'Potion', basePrice: 200, ingredients: ["æ˜Ÿéœ²æ°´", "æ°´è“®"], brewText: "é‡‘å…‰é–ƒé–ƒçš„å¹¸é‹è—¥æ°´ï¼Œå–äº†è‚¯å®šå¥½é‹çˆ†æ£šï¼" }, // T2 Water + T2 Water
  
  // T3 Potions (Require T2 + T3 or two T3 materials)
  "é«˜éšæ²»ç™‚è—¥æ°´": { tier: 3, type: 'Potion', basePrice: 350, ingredients: ["ç¨è§’ç¸æ¯›", "ç´…ç‚èŠ±ç“£"], brewText: "çè²´çš„æ²»ç™‚è—¥åŠ‘ï¼Œç¬é–“ä¾¿èƒ½å›å¾©çµ•å¤§éƒ¨åˆ†çš„å—å‚·ï¼" }, // T3 Water + T2 Fire
  "éš±å½¢è—¥æ°´": { tier: 3, type: 'Potion', basePrice: 400, ingredients: ["é¾æ¯è‰", "äººé­šé±—ç‰‡"], brewText: "è—¥æ°´æ¼¸æ¼¸è®Šé€æ˜ï¼Œé€£ç“¶å­éƒ½ä¸è¦‹äº†ï¼ç–‘...æ”¾åœ¨å“ªè£¡äº†?" }, // T3 Earth + T3 Wind
  "æ„›æƒ…è—¥æ°´": { tier: 3, type: 'Potion', basePrice: 300, ingredients: ["å½©è™¹èŠ±", "æ˜Ÿéœ²æ°´"], brewText: "ç²‰ç´…å¿ƒå¿ƒæ³¡æ³¡äº‚é£›ï¼Œæ„›æƒ…è—¥æ°´å¤ªæµªæ¼«äº†ï¼" }, // T3 Wind + T2 Water
  "è§£æ¯’è—¥": { tier: 3, type: 'Potion', basePrice: 250, ingredients: ["è¢å…‰çŸ³", "æ¯’è›‡ç‰™"], brewText: "åªè¦ä¸­æ¯’å¾Œ5åˆ†é˜å…§é£²ä¸‹ï¼Œä¾¿å¯ä»¥æŠµæ“‹ä¸€åˆ‡æ¯’ï¼...æ™‚é–“éäº†çš„è©±è—¥æ•ˆæœƒé™ä½ä¸€é»é»ã€‚" }, // T3 Earth + T1 Fire
  "å¼·åŠ›ç«ç„°è—¥æ°´": { tier: 3, type: 'Potion', basePrice: 450, ingredients: ["ç«èœ¥èœ´å°¾", "ç«ç´…æ™¶"], brewText: "ç«ç„°åƒé¾æ²é¢¨ä¸€æ¨£åœ¨ç“¶ä¸­æ—‹è½‰ï¼è¶³ä»¥èåŒ–é‹¼éµï¼" } // BUG-4 Fix Recipe
};

// å°‡æ‰€æœ‰é…æ–¹æå–å‡ºä¾†ï¼Œç”¨æ–¼ CR-11 æ’åº
const POTION_KEYS_ORDERED = Object.keys(ITEM_DATA).filter(k => ITEM_DATA[k].type === 'Potion');


// --- ä»»å‹™èˆ‡æ•…äº‹æ•´åˆ (ä¿®å¾© BUG 7) ---
const QUEST_EVENTS = {
  "ä½éšæ²»ç™‚è—¥æ°´": {
    request: "å¹´è¼•çš„å­¸å¾’å—äº†è¼•å‚·ï¼Œæ€¥éœ€ä¸€ç“¶ä½éšæ²»ç™‚è—¥æ°´ä¾†æ²»ç™‚ã€‚",
    success: ["å­¸å¾’å–ä¸‹è—¥æ°´å¾Œå‚·å£ç¬é–“ç™’åˆï¼Œä»–æ¿€å‹•åœ°å‘ä½ æ·±æ·±ä¸€é èº¬ï¼Œæ‰¿è«¾ä»¥å¾Œåªå…‰é¡§ä½ çš„åº—ã€‚", "å­¸å¾’æ€¥é€Ÿè·‘å›åº—å…§ç¹¼çºŒå·¥ä½œï¼Œä½ æƒ³å«ä»–ä¼‘æ¯ä¸€æœƒä¹Ÿä¾†ä¸åŠäº†ã€‚"],
    fail: "å­¸å¾’å˜†äº†å£æ°£ï¼Œèªªå‚·å£ä¸èƒ½å†æ‹–äº†ï¼Œè½‰èº«å‰å¾€å¦ä¸€å®¶è—¥é‹ªã€‚"
  },
  "ä½éšæ¯’è—¥": {
    request: "æŸä½å•†äººè¨‚è³¼äº†ä½éšæ¯’è—¥ï¼Œç”¨é€”å¯ç–‘ï¼Œä½†å ±é…¬è±åšã€‚",
    success: ["å•†äººå¾®ç¬‘è‘—æ”¶ä¸‹ï¼Œèªªã€Œé€™ç“¶æœƒè®“æŸå€‹è²´æ—æ°¸é é–‰å˜´ã€â€¦ä½ æ±ºå®šä¸è¿½å•ï¼Œæ”¶ä¸‹å ±é…¬ï¼Œç•¢ç«Ÿé€™å°±æ˜¯é»‘å¸‚çš„è¦å‰‡ã€‚", "ä½éšæ¯’è—¥çš„è—¥æ•ˆå¤ªå¥½äº†ï¼ŒåŸå…§çš„é¼ æ‚£éƒ½è§£æ±ºäº†ï¼ä½ æ”¶åˆ°äº†åŸé˜²è»çš„çå‹µ (å’Œä¸€äº›è­¦å‘Š)ã€‚"],
    fail: "å•†äººå–æ¶ˆäº†è¨‚å–®ï¼Œå› ç‚ºä»–å·²ç¶“æ‰¾åˆ°å…¶ä»–çš„æ‰‹æ®µäº†ã€‚"
  },
  "é€Ÿåº¦è—¥æ°´": {
    request: "ç›œè³Šéœ€è¦é€Ÿåº¦è—¥æ°´ä¾†æ“ºè„«å®ˆè¡›çš„è¿½æ•ã€‚",
    success: ["ç›œè³Šå–å®Œå¾Œç¬é–“ç¹äº†åº—è£¡ä¸‰åœˆï¼Œé‚„èªªã€Œé€™è¼©å­æ²’è·‘é€™éº¼å¿«ï¼ã€ä¸¦çµ¦ä½ ç•™ä¸‹äº†ä¸€å¡Šå¯¶çŸ³ã€‚", "ç›œè³Šæœ¬ä¾†æ‰“ç®—ä¸çµ¦éŒ¢ç›´æ¥è·‘èµ°ï¼Œä½ å¾®å¾®ä¸€ç¬‘ï¼Œç›œè³Šä¹–ä¹–åœ°æŠŠéŒ¢ç•™ä¸‹è—¥éŒ¢äº†ã€‚"],
    fail: "ç›œè³Šç„¦æ€¥åœ°çœ‹è‘—çª—å¤–ï¼Œå› ç‚ºæ²’æœ‰è—¥æ°´è€ŒéŒ¯å¤±äº†é€ƒè·‘çš„æœ€ä½³æ™‚æ©Ÿã€‚"
  },
  "ç«ç„°è—¥æ°´": {
    request: "è€æ³•å¸«è¦å°ä»˜ä¸€éš»å†°é¾ï¼Œæƒ³è¦ç«ç„°è—¥æ°´å¢å¼·ç«åŠ›ã€‚",
    success: ["è€æ³•å¸«ä¸€å£é£²ç›¡ï¼Œé¬å­ç¬é–“ç‡’ç´…ï¼Œèˆˆå¥®åœ°å–Šè‘—ã€Œé€™å°±æ˜¯æˆ‘è¦çš„é¾ç„°ä¹‹åŠ›ï¼ã€ä»–çµ¦äº†ä½ é¡å¤–çš„é…¬è¬ã€‚", "è€æ³•å¸«æ‹¿è‘—ç«ç„°è—¥æ°´å°ç©ºä¸€å™´ï¼Œå™´å‡ºåå…¬å°ºç«æŸ±ï¼Œå…¨å ´æ­¡å‘¼ï¼ä½ è¢«è­½ç‚ºç«ç„°éŠé‡‘å¸«ï¼"],
    fail: "è€æ³•å¸«æ–æ–é ­ï¼Œèªªæ²’æœ‰ç«ç„°è—¥æ°´å°±ç„¡æ³•å®Œæˆä»»å‹™ï¼Œæ‚»æ‚»ç„¶é›¢é–‹ã€‚"
  },
  "å¼·åŠ›ç«ç„°è—¥æ°´": { // BUG-4 Quest
    request: "ä¸€æ”¯é å¾è»éœ€è¦æœ€é ‚ç´šçš„ç«ç„°è—¥æ°´ä¾†å°æŠ—é å¤å·¨é¾ã€‚",
    success: ["é å¾è»çš„éšŠé•·æˆåŠŸæ“Šæ•—äº†å·¨é¾ï¼Œä»–å°‡ä¸€æšå‚³å¥‡ç´šçš„å‹³ç« ä½œç‚ºå ±é…¬é€çµ¦ä½ ã€‚", "è—¥æ°´çš„ç«ç„°å½¢æˆäº†ä¸€é“é˜²ç¦¦ç‰†ï¼Œé˜»æ­¢äº†å·¨é¾å…¥ä¾µï¼Œæ‹¯æ•‘äº†æ•´å€‹æ‘èŠï¼ä½ æˆç‚ºäº†å®¶å–»æˆ¶æ›‰çš„è‹±é›„ã€‚"],
    fail: "é å¾è»éšŠé•·å› ç‚ºç«åŠ›ä¸è¶³è€Œå—æŒ«ï¼Œæ±ºå®šå»å…¶ä»–åŸå¸‚å°‹æ‰¾å¹«åŠ©ã€‚"
  },
  "åŠ›é‡è—¥æ°´": {
    request: "å¤§åŠ›å£«è¦åŠ›é‡è—¥æ°´æŒ‘æˆ°å·¨ç¸ï¼Œå±•ç¾è‚Œè‚‰ã€‚",
    success: ["å¤§åŠ›å£«å–ä¸‹å¾Œå–®æ‰‹èˆ‰èµ·å·¨çŸ³ï¼Œç¾å ´è§€çœ¾å°–å«é€£é€£ï¼ä»–å¤§æ–¹åœ°æ”¯ä»˜äº†å ±é…¬ï¼Œä¸¦ç¨±è®šä½ æ˜¯æœ€å¼·çš„éŠé‡‘å¸«ã€‚", "å¤§åŠ›å£«å–äº†ä¹‹å¾Œå»æŒ‘æˆ°å·¨ç¸ï¼ŒæˆåŠŸç‹©çµå·¨ç¸å¾Œä»–æ±ºå®šé€çµ¦ä½ ä¸€äº›é­”è—¥ç´ æç­”è¬ã€‚"],
    fail: "å¤§åŠ›å£«å‚é ­å–ªæ°£åœ°é›¢é–‹ï¼Œçœ‹ä¾†ä»–çš„æŒ‘æˆ°è¦å»¶æœŸäº†ã€‚"
  },
  "å¹¸é‹è—¥æ°´": {
    request: "è²´æ—å°å§æ€¥éœ€å¹¸é‹è—¥æ°´ï¼Œå¸Œæœ›èƒ½åœ¨æ˜å¤©çš„è³­å±€ä¸­ç²å‹ã€‚",
    success: ["è²´æ—å°å§å–ä¸‹å¾Œåœ¨è³­å ´é€£è´ä¸‰æŠŠï¼Œå¥¹æŠŠè´ä¾†çš„é‡‘å¹£åˆ†ä½ ä¸€éƒ¨åˆ†ï¼é‚„é€ä½ äº†ä¸€ä»¶å°ç¦®ç‰©ã€‚", "è²´æ—å°å§åœ¨è³­å±€ä¸­ç²å‹ï¼ŒæˆåŠŸå’Œä¸‰ä½å¤§å®¢æˆ¶ç°½ç´„ä¸¦æ‰¿è«¾ä»¥å¾Œå¹«åŠ©ä»–å€‘å®¶æ—é‹é€è²¨ç‰©ã€‚"],
    fail: "è²´æ—å°å§å¤±æœ›åœ°èªªï¼šã€Œæ²’æœ‰å¹¸é‹è—¥æ°´ï¼Œæˆ‘çš„é‹æ°£ä¸€å®šæœƒå¾ˆå·®ï¼ã€"
  },
  "é«˜éšæ²»ç™‚è—¥æ°´": {
    request: "å—é‡å‚·çš„çš‡å®¶è­·è¡›æ€¥éœ€é«˜éšæ²»ç™‚è—¥æ°´æ•‘å‘½ã€‚",
    success: ["çš‡å®¶è­·è¡›å–ä¸‹è—¥æ°´å¾Œæ‰€æœ‰å‚·å£ç«‹åˆ»å›å¾©ï¼Œæ¿€å‹•åœ°æ„Ÿè¬ä½ çš„æ•‘å‘½ä¹‹æ©ï¼", "çš‡å®¶è­·è¡›å–ä¸‹é­”è—¥å¾Œç”¦é†’ï¼Œä»–é»˜é»˜çµ¦ä½ ä¸€è¢‹é‡‘å¹£ï¼Œæ„Ÿè¬ä½ æ•‘äº†ä»–ä¸€å‘½ï¼"],
    fail: "é¨å£«çš„è‡‰è‰²è¶Šä¾†è¶Šå·®ï¼Œè¢«åŒä¼´ç·Šæ€¥å¸¶èµ°ï¼Œä½ æ„Ÿåˆ°éå¸¸éºæ†¾ã€‚"
  },
  "éš±å½¢è—¥æ°´": {
    request: "æ½›è¡Œè€…å…¬æœƒéœ€è¦éš±å½¢è—¥æ°´åŸ·è¡Œä¸€é …ç§˜å¯†ä»»å‹™ã€‚",
    success: ["æ½›è¡Œè€…å…¬æœƒçš„ä»£è¡¨å–ä¸‹å¾Œæ¶ˆå¤±åœ¨ç©ºä¸­ï¼Œåªç•™ä¸‹ä¸€å¥ã€Œä¸‹æ¬¡å†ä¾†å¤šè²·å¹¾ç“¶ï¼ã€ä½ æ”¶åˆ°äº†ä¸€å¼µé»‘å¸‚é‡‘å¹£åˆ¸ã€‚", "åŸä¾†æ˜¯è¦ç”¨ä¾†å·è½å¤§è‡£æœƒè­°ï¼Œä»–é»˜é»˜çµ¦ä½ ä¸€è¢‹é‡‘å¹£ï¼Œä¸¦è¦ä½ ä¿å®ˆç§˜å¯†ã€‚"],
    fail: "å…¬æœƒä»£è¡¨ç•™ä¸‹äº†ä¸€å¼µå¯«è‘—ã€Œä¸‹æ¬¡å†æœƒã€çš„å­—æ¢ï¼Œäººå°±æ¶ˆå¤±äº†ã€‚"
  },
  "æ„›æƒ…è—¥æ°´": {
    request: "å®³ç¾çš„ç²¾éˆæƒ³è¦æ„›æƒ…è—¥æ°´å‘æš—æˆ€å°è±¡å‘Šç™½ã€‚",
    success: ["ç²¾éˆå–ä¸‹å¾Œå°è‘—æ¨¹å‘Šç™½ï¼Œçµæœæ¨¹çœŸçš„å›æ‡‰äº†ï¼å…¨æ£®æ—éƒ½è½Ÿå‹•äº†ï¼Œä½ æ”¶åˆ°äº†è±åšçš„ç´…åŒ…ã€‚", "å®³ç¾çš„ç²¾éˆå–ä¸‹é­”è—¥ï¼Œç¥ˆæ±‚è‡ªå·±çš„å‘Šç™½é †åˆ©ï¼Œçµæœå‘Šç™½æˆåŠŸï¼Œçµ¦ä½ é€ä¾†äº†ç¦®ç‰©ï¼ä½ çš„æ„›æƒ…è—¥æ°´æˆäº†å‚³èªªã€‚"],
    fail: "ç²¾éˆå®³ç¾åœ°è·‘é–‹äº†ï¼Œèªªæ²’æœ‰è—¥æ°´ä»–ä¸æ•¢é¢å°å¿ƒæ„›çš„äººã€‚"
  },
  "è§£æ¯’è—¥": {
    request: "åŸé®å±…æ°‘è¢«å‚³æŸ“çš„æ¯’ç´ æ„ŸæŸ“ï¼Œæ€¥éœ€è§£æ¯’è—¥ã€‚",
    success: ["å±…æ°‘å–ä¸‹è—¥æ°´å¾Œç«‹åˆ»æ¢å¾©ï¼Œé‚„é€ä½ ä¸€ç±ƒæ–°é®®æ°´æœï¼", "ä½ æˆåŠŸæ·¨åŒ–äº†åŸå¸‚çš„æ°´æºï¼Œå¸‚é•·æ±ºå®šçµ¦ä½ é ’ç™¼æ¦®è­½éŠé‡‘å¸«çš„ç¨±è™Ÿï¼"],
    fail: "å±…æ°‘æƒ…æ³æƒ¡åŒ–ï¼Œè¢«éš”é›¢æ²»ç™‚ï¼Œä½ æ„Ÿåˆ°éå¸¸æ²®å–ªã€‚"
  }
};

// --- æ¯æ—¥äº‹ä»¶ (Daily Events) ---
const DAILY_EVENTS = [
    {
        name: "å¸‚å ´éœ€æ±‚æ¿€å¢",
        description: "éŠé‡‘è¡“å¸«å…¬æœƒç™¼å¸ƒå…¬å‘Šï¼šä»Šå¤©æ‰€æœ‰è—¥æ°´å ±é…¬ç¿»å€ï¼",
        rewardModifier: (potionData) => potionData.tier >= 1 ? 2.0 : 1.0, // PC - Chane to ignore tier
        fatigueModifier: () => 1.0,
        riskModifier: () => 1.0,
        type: 'reward_event'
    },
	{
        name: "å¸‚å ´éœ€æ±‚æ¿€å¢",
        description: "æœ€è¿‘æœ‰å¤§å‹ç‹©çµæ´»å‹•ï¼Œå†’éšªè€…éƒ½åœ¨æ”¶è³¼è—¥åŠ‘äº†ã€‚ä»Šå¤©æ‰€æœ‰è—¥æ°´å ±é…¬ç¿»å€ï¼",
        rewardModifier: (potionData) => potionData.tier >= 1 ? 2.0 : 1.0, // PC - Chane to ignore tier
        fatigueModifier: () => 1.0,
        riskModifier: () => 1.0,
        type: 'reward_event'
    },
    {
        name: "è‰åŸå’Œæ£®æ—è³‡æºå¤§è±æ”¶",
        description: "ä»Šæ—¥ç–¾é¢¨è‰åŸå’Œå¤§åœ°æ£®æ—çš„æ¢ç´¢ï¼Œç–²å‹æ¶ˆè€—æ¸›åŠï¼",
        rewardModifier: () => 1.0,
        fatigueModifier: (area) => (area === 'wind' || area === 'earth') ? 0.5 : 1.0,
        riskModifier: () => 1.0,
        type: 'explore_event'
    },
	{
        name: "ç«å±±å’Œæ¹–æ³Šè³‡æºå¤§è±æ”¶",
        description: "ä»Šæ—¥çƒˆç„°ç«å±±å’Œæ·±æµ·æ¹–æ³Šçš„æ¢ç´¢ï¼Œç–²å‹æ¶ˆè€—æ¸›åŠï¼",
        rewardModifier: () => 1.0,
        fatigueModifier: (area) => (area === 'fire' || area === 'water') ? 0.5 : 1.0,
        riskModifier: () => 1.0,
        type: 'explore_event'
    },
    {
        name: "ç«å±±ç®¡åˆ¶",
        description: "å®ˆè¡›éšŠåŠ å¼·äº†å°ç«å±±çš„ç®¡åˆ¶ï¼Œä»Šæ—¥æ¢ç´¢çƒˆç„°ç«å±±å¤±æ•—çš„é¢¨éšªæé«˜ 30%ï¼",
        rewardModifier: () => 1.0,
        fatigueModifier: () => 1.0,
        riskModifier: (area) => area === 'fire' ? 1.3 : 1.0,
        type: 'explore_event'
    },
	    {
        name: "è‰åŸæ¡é›†éé‡",
        description: "è‰åŸè¿‘æ—¥è¢«æ¡é›†éé‡ï¼Œä»Šæ—¥æ¢ç´¢ç–¾é¢¨è‰åŸå¤±æ•—çš„é¢¨éšªæé«˜ 30%ï¼",
        rewardModifier: () => 1.0,
        fatigueModifier: () => 1.0,
        riskModifier: (area) => area === 'wind' ? 1.3 : 1.0,
        type: 'explore_event'
    },
	    {
        name: "æ£®æ—å±æ©Ÿ",
        description: "å†’éšªè€…å…¬æœƒå®£ä½ˆæ£®æ—è¿‘æ—¥ç™¼ç¾æœ‰é«˜ç´šé­”ç¸å¾˜å¾Šï¼Œä»Šæ—¥æ¢ç´¢å¤§åœ°æ£®æ—å¤±æ•—çš„é¢¨éšªæé«˜ 30%ï¼",
        rewardModifier: () => 1.0,
        fatigueModifier: () => 1.0,
        riskModifier: (area) => area === 'earth' ? 1.3 : 1.0,
        type: 'explore_event'
    },
	    {
        name: "æ¹–æ³Šä¹¾æ¶¸",
        description: "é€£æ—¥ä¾†çš„ä¹¾æ—±ä»¤æ¹–æ³Šé™·å…¥ä¹¾æ¶¸ï¼Œä»Šæ—¥æ¢ç´¢æ·±æµ·æ¹–æ³Šå¤±æ•—çš„é¢¨éšªæé«˜ 30%ï¼",
        rewardModifier: () => 1.0,
        fatigueModifier: () => 1.0,
        riskModifier: (area) => area === 'water' ? 1.3 : 1.0,
        type: 'explore_event'
    },
    {
        name: "æ™®é€šçš„ä¸€å¤©",
        description: "ä»Šå¤©é¢¨å¹³æµªéœï¼Œä¸€åˆ‡å¦‚å¸¸ã€‚",
        rewardModifier: () => 1.0,
        fatigueModifier: () => 1.0,
        riskModifier: () => 1.0,
        type: 'normal'
    }
];

// --- æ¢ç´¢åœ°é»èˆ‡ç”¢å‡ºç‰© (CR-4) ---
const materialsByArea = {
  wind: ["é¢¨è¡Œè‰", "å¹¸é‹çµ¨æ¯›", "ç¨è§’ç¸æ¯›", "å½©è™¹èŠ±"],
  fire: ["ç«ç´…æ™¶", "æ¯’è›‡ç‰™", "ç´…ç‚èŠ±ç“£", "ç«èœ¥èœ´å°¾"],
  water: ["å†°é›ªè˜‘è‡", "æ°´è“®", "æ˜Ÿéœ²æ°´", "äººé­šé±—ç‰‡"],
  earth: ["æœˆå…‰è‰", "ç²—ç³™ç¤¦çŸ³", "é¾æ¯è‰", "è¢å…‰çŸ³"]
};

// --- éŠæˆ²å¹³è¡¡ï¼šèƒŒåŒ…æ“´å±•è²»ç”¨ (CR-10) ---
const MAX_INVENTORY_UPGRADES = [40, 50, 65, 80, 100];
const MAX_INVENTORY_UPGRADE_COSTS = [100, 250, 500, 800, 1500];

    
// --- æ•…äº‹æ–‡æœ¬ ---
const exploreStories = {
  wind: ["ä¸€é™£å¸¶è‘—èŠ±é¦™çš„é¢¨æ‹‚éï¼Œä½ åœ¨è‰åœ°ä¸Šæ…¢æ…¢è¸±æ­¥ï¼Œå°‹æ‰¾ç¨€æœ‰çš„ç´ æã€‚", 
		"ä¸€é™£å¸¶è‘—èŠ±é¦™çš„é¢¨æ‹‚éï¼Œä½ çš„æŠ«é¢¨å’Œæ›åœ¨è…°é–“çš„å°ç“¶å­ä¸€èµ·è¼•è¼•æ™ƒå‹•ã€‚",
		"ä½ èµ°éæ™‚ï¼Œè‰å°–æ“¦éä½ çš„é´å­èˆ‡æŠ«é¢¨ï¼Œå¸¶èµ·ä¸€é™£æ·¡æ·¡çš„é’è‰é¦™ã€‚",
		"ä½ éš¨æ‰‹æ‘˜ä¸‹ä¸€æ ¹ç´°é•·çš„è‰å«åœ¨å˜´è£¡ï¼Œä»»ç”±è‡ªå·±åœ¨é™½å…‰è£¡æ…¢æ…¢è¸±æ­¥ã€‚",
		"ç„¡é‚Šçš„è‰åŸåœ¨çœ¼å‰é‹ªå±•é–‹ä¾†ï¼Œé è™•çš„é¢¨ç¾Šæ…¢æ‚ æ‚ åœ°åƒè‰ï¼Œä½ ç™¼ç¾äº†å¹¾æ ªé–ƒçˆè‘—å…‰é»çš„å¥‡ç•°æ¤ç‰©ã€‚",
		"ä½ æ‰¾åˆ°ä¸€å¡Šé‚„ç®—å¹³æ•´çš„å²©çŸ³åä¸‹ï¼ŒæŠŠèƒŒåŒ…æ”¾åœ¨æ—é‚Šï¼Œè®“è‚©è†€å¥½å¥½ä¼‘æ¯ä¸€ä¸‹ã€‚",
		 "æœ‰å¹¾éš»å¥½å¥‡çš„å°æ¨¹ç²¾å¾æ¨¹æ ¹å¾Œæ¢å‡ºé ­ï¼Œæ‚„æ‚„æ‰“é‡ä½ ï¼Œåˆè¿…é€Ÿèº²å›å½±å­è£¡ã€‚",
		 "ä½ æŠ¬é ­çœ‹è¦‹å¤©ç©ºåªéœ²å‡ºä¸€å°å¡Šè—è‰²ï¼Œå¿ƒæƒ³æˆ–è¨±ä»Šå¤©æ˜¯å€‹é©åˆè¿·è·¯ï¼Œä¹Ÿæ˜¯é©åˆç™¼ç¾é©šå–œçš„æ—¥å­ã€‚",
		 "é è™•æœ‰å†’éšªè€…çš„éšŠä¼ç¶“éï¼Œå‚³ä¾†éš±ç´„çš„å°è©±è²ï¼Œçœ‹ä¾†ä»–å€‘ä»Šå¤©çš„æ”¶ç©«å¾ˆè±å¯Œå‘¢ã€‚",
		 "åœ¨é€™æ¨£å®‰éœåˆå»£é—Šçš„è‰åŸä¸Šï¼Œä½ åªæƒ³å¤šè³´ä¸€æœƒå…’ï¼Œè®“æ™‚é–“è·Ÿè‘—è‰ä¸€èµ·æ…¢æ…¢æ–æ™ƒã€‚",
		 "ä½ åœ¨ä¸€å¡ŠæŸ”è»Ÿçš„è‰åœ°ä¸Šèººä¸‹ï¼ŒèƒŒåŒ…ç•¶æ•é ­ï¼Œçœ‹è‘—ä¸€éš»å½©ç¾½å°é³¥åœ¨é ­é ‚ç›¤æ—‹ã€‚"
		],
  fire: ["ä¹¾ç‡¥çš„ç†±æ°£æ’²é¢è€Œä¾†ï¼Œä½ å°å¿ƒç¿¼ç¿¼åœ°æ²¿è‘—ç«å±±å²©æ¼¿æµéçš„ç—•è·¡æ¢ç´¢ï¼Œå¸Œæœ›é¿é–‹æœ‰æ¯’çš„æ°£é«”ã€‚",
		"ä½ åœ¨æ´çªŸè£¡é»äº®äº†é­”æ³•ç«çƒï¼Œç©ºæ°£å¸¶è‘—äº›è¨±ç¡«ç£ºçš„å‘³é“ï¼Œä½ åœ¨ç™¼å…‰çš„æ™¶é«”ç¸«éš™ä¸­ç™¼ç¾äº†ç‰©å“ã€‚",
		"é æ–¹å‚³ä¾†ä¸çŸ¥åé­”ç¸çš„ä½å¼ï¼Œè¦å°ˆå¿ƒä¸€é»è­¦æˆ’å››å‘¨ç’°å¢ƒäº†ã€‚",
		"ç«å±±å››å‘¨å¤ªéç‚ç†±äº†ï¼Œä½ åœ¨æ€è€ƒä¸‹æ¬¡è¦ä¸è¦å¸¶ä¸Šä¸€ç“¶æŠ—ç‚è—¥åŠ‘ï¼Œå¯ä»¥è¼•é¬†æ¶¼å¿«ä¸€é»ã€‚",
		"ä½ èµ°äº†ä¸€æœƒï¼Œé–‹å§‹æœ‰é»é¤“äº†ï¼Œä½ æ‰“é‡å››å‘¨ï¼Œçœ‹çœ‹æœ‰æ²’æœ‰ä»€éº¼å¯ä»¥ä½œç‚ºåˆé¤çš„é£Ÿæã€‚",
		"ä½ æŠµå—ä¸äº†é€™ä»½ç‚ç†±äº†ï¼Œæ±ºå®šå…ˆåä¸‹ä¾†ä¼‘æ¯ä¸€å°æœƒã€‚",
		"ç©ºæ°£å¸¶è‘—äº›è¨±ç¡«ç£ºçš„å‘³é“ï¼Œä½ æœ‰é»æƒ³å¿µä¸Šæ¬¡æµ¸æ³¡çš„æº«æ³‰äº†ã€‚"
		],
  water: ["å²¸é‚Šæœ‰éš»é‡é¹¿åœ¨å–æ°´ï¼Œä½ æŠŠæ‰‹ä¼¸é€²æ¹–æ°´è£¡ï¼Œå†°æ¶¼çš„è§¸æ„Ÿè®“ä½ ç²¾ç¥ä¸€æŒ¯ã€‚",
		"æ¹–é¢åƒä¸€å¤§ç‰‡æ”¤é–‹çš„é¡å­ï¼Œå¾®é¢¨æ‹‚éï¼Œä½ æ·±å…¥æ¹–ç•”æ²¼æ¾¤ï¼Œæ‰¾åˆ°äº†è¢«æµªèŠ±æ²–ä¸Šå²¸çš„ç‰©å“ã€‚",
		"ä¸é è™•æœ‰å°ç²¾éˆæ‡¶æ´‹æ´‹åœ°è¶´åœ¨è˜‘è‡ä¸Šæ‰“ç›¹ï¼Œé¼»å°–é‚„æ²¾è‘—èŠ±ç²‰ã€‚",
		"æ¹–é¢åƒä¸€å¤§ç‰‡æ”¤é–‹çš„é¡å­ï¼ŒæŠŠå¤©ç©ºå’Œé è™•å±±å·’éƒ½æ”¶é€²äº†æ‡·è£¡ã€‚",
		"ä½ ç¿»å‡ºå°ç­†è¨˜æœ¬ï¼Œåœ¨é è§’è¨˜ä¸‹ã€Œæ¹–é‚Šåˆé¤ï¼šå‘³é“åŠ åˆ†ï¼Œé¢¨æ™¯æ»¿åˆ†ã€ã€‚",
		"æ•¸éš»å°é´¨å­æµ®åœ¨æ°´é¢ä¸Šï¼Œå¥½å¥‡åœ°çœ‹ä½ å’¬è‘—éºµåŒ…ï¼Œåƒåœ¨ç­‰ä½ åˆ†ä¸€å£ã€‚",
		"ä½ ä¼¸æ‡¶è…°ç«™èµ·ä¾†ï¼Œæ‹æ‰è¡£æœä¸Šçš„éºµåŒ…å±‘ï¼Œå¿ƒæƒ³ä¸‹æ¬¡ä¹Ÿè¨±è©²å¸¶é»é»å¿ƒçµ¦é‚£äº›é¥å˜´çš„å°é´¨å­ã€‚",
		"ä½ çœ‹è‘—æ°´å¡˜è£¡æ™ƒå‹•çš„å€’å½±ï¼Œå¿ä¸ä½åœ¨æ°´é¢ä¸Šè¼•è¼•é»äº†ä¸€ä¸‹ï¼Œè®“è‡ªå·±çš„å½±å­è®Šå¾—æ»‘ç¨½æ‰­æ›²ã€‚",
		"å¤©é‚Šçš„é›²è¢«æ›¬å¾—ç™¼äº®ï¼Œå¶çˆ¾æœ‰ä¸€å…©æœµå‘ˆç¾å¥‡æ€ªçš„å½¢ç‹€ï¼Œåƒæ˜¯èª°å·å·åœ¨é›²è£¡è—äº†å·¨å¤§çš„é­”æ³•ç”Ÿç‰©ã€‚"
		],
  earth: ["é™½å…‰å¾æ¨¹è‘‰ç¸«éš™ç‘ä¸‹ï¼Œä½ é †è‘—èœ¿èœ’çš„å°å¾‘æ¼«æ­¥ï¼Œä¸€æ£µé•·æ»¿è‹”è˜šçš„å¤§æ¨¹ä¸‹ä¼¼ä¹è—è‘—ä»€éº¼ç§˜å¯†ã€‚",
		"æ£®æ—æ·±è™•å‚³ä¾†é³¥é³´ï¼Œä½ è¹²ä¸‹èº«ï¼Œæ’¥é–‹åšåšçš„è½è‘‰å’Œæ³¥åœŸï¼Œæ„Ÿè¦ºåˆ°æ³¥åœŸæ·±è™•å‚³ä¾†çš„å¾®å¼±éœ‡å‹•ã€‚",
		"é™½å…‰å¾æ¨¹è‘‰ç¸«éš™ç‘ä¸‹ï¼Œä½ ç™¼ç¾äº†ä¸€å€‹å¾ˆé©åˆæ¡é›†çš„åœ°æ–¹ï¼Œä»”ç´°åœ°å¼µæœ›ã€‚",
		"å†·æ¶¼çš„ç©ºæ°£å¸¶è‘—äº›è¨±ç¤¦ç‰©çš„å‘³é“ï¼Œè®“äººä¸è‡ªè¦ºæ·±å‘¼å¸ï¼Œè…¦è¢‹ä¹Ÿæ¸…é†’äº†ä¸å°‘ã€‚",
		"åœ¨é€™éœè¬çš„æ£®æ—è£¡ï¼Œä½ æ±ºå®šæš«æ™‚ä¸å»æƒ³å±éšªèˆ‡ä»»å‹™ï¼Œåªç•¶è‡ªå·±æ˜¯åœ¨é¿æš‘çš„ç§˜å¯†åŸºåœ°è£¡å·æ‡¶ã€‚",
		"ä½ é †è‘—èœ¿èœ’çš„å°å¾‘æ¼«æ­¥ï¼Œæ¯è¸©ä¸€ä¸‹ï¼Œè½è‘‰å°±ç™¼å‡ºè¼•è„†è²éŸ¿ï¼Œåƒåœ¨æ›¿ä½ ä¼´å¥ã€‚",
		"æ£®æ—æ·±è™•å‚³ä¾†é³¥é³´èˆ‡ä¸çŸ¥åé­”ç¸çš„ä½å¼ã€‚",
		"ä½ åœ¨ä¸€æ£µé•·æ»¿è‹”è˜šçš„å¤§æ¨¹æ—åä¸‹ï¼Œç¿»é–‹åœ°åœ–ï¼Œéš¨æ‰‹åœ¨ç©ºç™½è™•ç•«äº†å¹¾ç­†äº‚ä¸ƒå…«ç³Ÿçš„å¡—é´‰ã€‚",
		"é æ–¹å‚³ä¾†å¾®å¼±çš„éˆ´è²ï¼Œä¹Ÿè¨±æ˜¯å•†éšŠç¶“éï¼Œä½†ä½ æš«æ™‚æ²’æœ‰æ‰“ç®—èµ·èº«ã€‚"
		]
};

const brewFail = [
  "è®Šæˆä¸€åœ˜ç´«è‰²é»é»çš„æ³¥å·´ï¼Œé‚„å°ä½ åèˆŒé ­â€¦",
  "ç™¼å‡ºè¶…ç´šè‡­çš„å‘³é“ï¼çª—å¤–çš„è²“é ­é·¹éƒ½é£›èµ°äº†ï¼",
  "è½Ÿï¼é‹å­å°çˆ†ç‚¸ï¼Œæ»¿å±‹å­å½©è‰²ç…™éœ§ä¸‰å¤©æ‰æ•£ã€‚",
  "è®Šæˆæœƒè·³çš„é’è›™æœå‡ï¼Œè¹¦è¹¦è·³è·³é€ƒå‡ºçª—å¤–â€¦",
  "æ•´é‹è®Šæˆé»‘è‰²ï¼Œé‚„é•·å‡ºå°è§¸æ‰‹å°ä½ æ®æ‰‹ï¼"
];

const newDayStories = [
  "é™½å…‰å¾çª—æˆ¶ç‘é€²ä¾†ï¼Œé–€å£çš„é¢¨éˆ´å®å®å™¹å™¹éŸ¿è‘—è¿æ¥æ–°çš„ä¸€å¤©ã€‚",
  "è²“é ­é·¹å¸¶è‘—ä¸€å°æ–°çš„å§”è¨—ä¿¡é£›ä¾†ï¼Œæ–°çš„å†’éšªé–‹å§‹å•¦ï¼",
  "åº—é–€å£é–‹äº†ä¸€æœµå¾æ²’çœ‹éçš„å°èŠ±ï¼Œä»Šå¤©ä¹Ÿæœƒæ˜¯ç¾å¥½çš„ä¸€å¤©ï½",
  "æ—é‚ŠéºµåŒ…åº—çƒ¤éºµåŒ…çš„é¦™å‘³é£„é€²å±‹å…§ï¼Œä»Šå¤©ä¹Ÿæœƒæ˜¯ç¾å¥½çš„ä¸€å¤©ï½",
  "é è™•å‚³ä¾†å†’éšªè€…å€‘çš„ç¬‘è²ï¼Œåˆæ˜¯å……æ»¿å¸Œæœ›çš„ä¸€å¤©ï¼"  
];

// --- éŠæˆ²ç‹€æ…‹ ---
			
		   
		 
		  
								  
									  
								  
			 
			  
											   
									 
								   
										   
										  
  

const BASE_MAX_INVENTORY = 30;
const MAX_FATIGUE = 20;

const INITIAL_GAME_STATE = {
    gold: 50,
    day: 1,
    fame: 0,
    inventory: {},
    cauldron: [],
    potions: {},
    fatigue: 0,
    invCount: 0,
    knownRecipes: [],
    currentQuest: null,
    dailyEvent: null,
    loggedFatigueFull: false,
    loggedInvFull: false,
    maxInventory: BASE_MAX_INVENTORY, // CR-10: New Property
    inventoryUpgradeLevel: 0,         // CR-10: New Property
};

let game = JSON.parse(JSON.stringify(INITIAL_GAME_STATE)); // Ensure deep copy on initialization

// --- æ ¸å¿ƒæ›´æ–°èˆ‡æ¸²æŸ“ (å„ªåŒ–) ---
function updateElement(id, content, isHtml = false) {
  const el = document.getElementById(id);
  if (el) {
    if (isHtml) {
      el.innerHTML = content;
    } else {
      el.textContent = content;
    }
  }
}

function renderGameState() {
  updateStatPanel();
								 
								   
										 
										   
										   
  renderInventory();
  renderPotions();
  renderCauldron();
  renderRecipes();
  updateExploreButtons();
						   
					
		  
  renderQuest(); // ç¢ºä¿ä»»å‹™åœ¨æ¯æ¬¡æ¸²æŸ“æ™‚éƒ½é¡¯ç¤º
  updateInventoryUpgradeButton(); // CR-10: Update upgrade button state
  autoSave();
}

function updateStatPanel() {
  updateElement('gold', game.gold);
  updateElement('day', game.day);
  updateElement('fame', game.fame);
  updateElement('fatigue', game.fatigue);
  updateElement('maxFatigue', MAX_FATIGUE);
  updateElement('invCount', game.invCount);
  updateElement('maxInv', game.maxInventory); // CR-10
}

function updateInventoryUpgradeButton() {
    const btn = document.getElementById('upgradeInvBtn');
    const level = game.inventoryUpgradeLevel;
    const nextMax = MAX_INVENTORY_UPGRADES[level];
    const cost = MAX_INVENTORY_UPGRADE_COSTS[level];

    if (level >= MAX_INVENTORY_UPGRADES.length) {
        btn.disabled = true;
        btn.textContent = 'ğŸ’ èƒŒåŒ…å·²å‡ç´šè‡³é ‚ç´šï¼';
    } else {
        btn.disabled = game.gold < cost;
        updateElement('nextMaxInv', nextMax);
        updateElement('upgradeCost', cost);
        btn.title = btn.disabled ? "é‡‘å¹£ä¸è¶³ï¼" : `èŠ±è²» ${cost} G æ“´å±•è‡³ ${nextMax}`;
        btn.textContent = `ğŸ’ æ“´å±•èƒŒåŒ…è‡³ ${nextMax} (è²»ç”¨ï¼š${cost} G)`;
    }
}

function upgradeInventory() { // CR-10: Upgrade logic
    const level = game.inventoryUpgradeLevel;
    if (level >= MAX_INVENTORY_UPGRADES.length) return;

    const cost = MAX_INVENTORY_UPGRADE_COSTS[level];
    const nextMax = MAX_INVENTORY_UPGRADES[level];

    if (game.gold >= cost) {
        game.gold -= cost;
        game.maxInventory = nextMax;
        game.inventoryUpgradeLevel++;
        addLog(`ğŸ’ èƒŒåŒ…ç©ºé–“æ“´å±•æˆåŠŸï¼æœ€å¤§å®¹é‡æå‡è‡³ ${nextMax}ï¼`, 'success');
    } else {
        addLog(`é‡‘å¹£ä¸è¶³ï¼æ“´å±•èƒŒåŒ…éœ€è¦ ${cost} Gã€‚`, 'fail');
    }
    renderGameState();
}


// --- ç–²å‹èˆ‡æ¢ç´¢æŒ‰éˆ• (ä¿®å¾© BUG 1) ---
function updateExploreButtons() {
  const isFatigued = game.fatigue >= MAX_FATIGUE;
  const isFull = game.invCount >= game.maxInventory;
  
  document.getElementById('fatigueWarning').style.display = game.fatigue >= 15 && !isFatigued ? 'inline' : 'none';

  const buttons = ['wind','fire','water','earth'];
  buttons.forEach(area => {
    const btn = document.getElementById('btn-'+area);
    if (btn) {
      btn.disabled = isFatigued || isFull;
      if (isFatigued) {
        btn.title = "ä»Šæ—¥å·²ç–²å‹ï¼Œè«‹æ˜å¤©å†æ¢ç´¢";
      } else if (isFull) {
        btn.title = "èƒŒåŒ…å·²æ»¿ï¼Œè«‹å…ˆæ•´ç†";
      } else {
        btn.title = "";
      }
    }
  });

  if (isFatigued && !game.loggedFatigueFull) {
    addLog("ä½ å·²ç¶“ç´¯å£äº†â€¦ä»Šå¤©ç„¡æ³•å†æ¢ç´¢äº†ã€‚", 'fail');
    game.loggedFatigueFull = true;
  }
  
  // æª¢æŸ¥èƒŒåŒ…æ˜¯å¦å‰›æ»¿ï¼ˆCR 5 è§£æ±ºï¼‰
  if (isFull && !game.loggedInvFull) {
      addLog("ä½ çš„èƒŒåŒ…æ»¿äº†ï¼å…ˆè³£æ‰æˆ–ä¸Ÿæ£„ä¸€äº›æ±è¥¿æ‰èƒ½ç¹¼çºŒæ¢ç´¢ã€‚", 'fail');
      game.loggedInvFull = true;
  } else if (!isFull) {
      game.loggedInvFull = false; // é‡ç½®æ»¿è¼‰æ——æ¨™
  }
}

// --- æ—¥èªŒç³»çµ± (CR-8: è‡ªå‹•æ»¾å‹•åˆ°é ‚éƒ¨) ---
function addLog(text, type = 'normal') {
  const log = document.getElementById('log');
  const entry = document.createElement('div');
  entry.className = `log-entry ${type}`;
  entry.innerHTML = `âœ ç¬¬${game.day}å¤©ãƒ»${text}`;
  
  // CR-8: Prepend to achieve scroll-to-top visual effect on new logs with flex-direction: column-reverse
  log.prepend(entry);
  
  // æ¸…ç†èˆŠæ—¥èªŒ
  if (log.children.length > 50) log.removeChild(log.lastChild); 
}

function clearLog() {
  document.getElementById('log').innerHTML = '';
}

// --- å­˜æª”åŠŸèƒ½ (BUG-2 Fix: å¾¹åº•é‡ç½®éŠæˆ²) --- 
function showSaveStatus(text) {
  const statusEl = document.getElementById('saveStatus');
  statusEl.textContent = text;
  statusEl.style.display = 'inline';
  setTimeout(() => statusEl.style.display = 'none', 3000);
}

							  
function openClearSaveModal() {
    document.getElementById('confirmModal').style.display = 'flex';
}

function clearSaveConfirmed(isConfirmed) {
    document.getElementById('confirmModal').style.display = 'none';
    if (isConfirmed) {
        // BUG-2 Fix: Use deep copy of INITIAL_GAME_STATE for complete reset
        game = JSON.parse(JSON.stringify(INITIAL_GAME_STATE)); 
        localStorage.removeItem('potionShopSave'); // æ¸…é™¤æœ¬åœ°å­˜æª”
        init(); // Re-initialize game state and UI
        addLog('æ‰€æœ‰è¨˜éŒ„å·²æ¸…é™¤ï¼Œé­”è—¥åº—é‡æ–°é–‹å¼µï¼', 'fail');
    } else {
        addLog('å–æ¶ˆæ¸…é™¤é€²åº¦ã€‚', 'normal');
    }
}

function saveGame() {
  const data = JSON.stringify(game, null, 2);
  const blob = new Blob([data], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const now = new Date();
  const timestamp = now.toISOString().slice(0,19).replace(/[-:T]/g,'');
  a.href = url;
  a.download = `Alchemy_Adventure_Save_${timestamp}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showSaveStatus('å­˜æª”å·²åŒ¯å‡ºåˆ°æ‚¨çš„è£ç½®ï¼');
}

function loadGame() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const loadedGame = JSON.parse(ev.target.result);
        // Basic validation for core properties
        if (loadedGame.gold !== undefined && loadedGame.day !== undefined) {
          game = loadedGame;
          // Ensure new properties are initialized if loading an old save
          game.currentQuest = game.currentQuest || null;
																  
          game.dailyEvent = game.dailyEvent && game.dailyEvent.riskModifier ? game.dailyEvent : DAILY_EVENTS.find(e => e.type === 'normal');
		   
          game.loggedFatigueFull = game.loggedFatigueFull || false;
          game.loggedInvFull = game.loggedInvFull || false;
          game.maxInventory = game.maxInventory || INITIAL_GAME_STATE.maxInventory; // CR-10
          game.inventoryUpgradeLevel = game.inventoryUpgradeLevel || INITIAL_GAME_STATE.inventoryUpgradeLevel; // CR-10
          
          renderGameState();
          addLog('å­˜æª”è¼‰å…¥æˆåŠŸï¼é­”è—¥åº—ç¹¼çºŒç‡Ÿæ¥­ï¼', 'success');
          showSaveStatus('å·²è®€å–å­˜æª”ï¼');
        } else {
          throw new Error("Invalid structure");
        }
      } catch (err) {
        addLog('å­˜æª”æ ¼å¼éŒ¯èª¤æˆ–å·²æå£ï¼Œç„¡æ³•è¼‰å…¥ã€‚', 'fail');
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function autoSave() {
  try {
    localStorage.setItem('potionShopSave', JSON.stringify(game));
  } catch (e) {
    console.error("Auto-save failed:", e);
  }
}

// --- æ¸²æŸ“å‡½æ•¸ ---

function getSortedInventoryItems() { // CR-7: æŒ‰å±¬æ€§æ’åº
    return Object.keys(game.inventory)
        .filter(item => game.inventory[item] > 0)
        .sort((a, b) => {
            const dataA = ITEM_DATA[a];
            const dataB = ITEM_DATA[b];
            return dataA.sortOrder - dataB.sortOrder; // ä½¿ç”¨ ITEM_DATA è£¡çš„ sortOrder
        });
}

function renderInventory() {
  const inv = document.getElementById('inventory');
  inv.innerHTML = '';
  
  let count = 0;
  const sortedItems = getSortedInventoryItems(); // CR-7: Use sorted list

  for (let item of sortedItems) {
    const qty = game.inventory[item];
    const data = ITEM_DATA[item];
    if (qty > 0) {
      count += qty;
      const div = document.createElement('div');
      // CR-7: Add element-based class for styling
      div.className = `item shadow-sm hover:shadow-lg transition-shadow element-${data.element}`;
      
      // CR-5: Simplified Discard Button and direct click to cauldron
      div.innerHTML = `
        <button class="action-btn discard" onclick="discardMaterial('${item}')" title="ä¸Ÿæ£„ 1 å€‹ç´ æ">
            -
        </button>
        <div class="item-content">
            <div class="item-info" onclick="addToCauldron('${item}')" title="é»æ“Šæ”¾å…¥é‹çˆ">
                ${data.icon} ${item} <span class="font-bold">Ã— ${qty}</span>
            </div>
									  
																																															  
					 
						 
				  
        </div>
      `;
      
      inv.appendChild(div);
    }
  }
  game.invCount = count;
  updateElement('invCount', count);
  updateElement('maxInv', game.maxInventory); // CR-10
}

function discardMaterial(item) {
    if (game.inventory[item] > 0) {
        game.inventory[item]--;
        game.invCount--;
        if (game.inventory[item] === 0) {
            delete game.inventory[item];
        }
        addLog(`ä½ ä¸Ÿæ£„äº† 1 ä»½ã€Œ${item}ã€ï¼ŒèƒŒåŒ…ç©ºé–“æ¸…å‡ºäº†ä¸€äº›ã€‚`, 'normal');
        renderGameState();
    }
}

function renderPotions() {
  const list = document.getElementById('potionsList');
  list.innerHTML = '';

  // CR-11: Use the predefined order for potions
  const sortedPotions = POTION_KEYS_ORDERED.filter(p => (game.potions[p]||0) > 0);
  
  for (let potion of sortedPotions) {
    const qty = game.potions[potion];
    const data = ITEM_DATA[potion];
    if (qty > 0) {
      const div = document.createElement('div');
      div.className = 'potion item shadow-sm hover:shadow-lg transition-shadow';
      
														  
      div.innerHTML = `
        <div class="potion-info text-center">
            ${potion} Ã— ${qty}
       
        </div>
        <button class="potion-sell-btn" onclick="sellPotion('${potion}', ${data.basePrice})">
            è²©å”® (${data.basePrice} G)
        </button>
      `;
      list.appendChild(div);
    }
  }
}

function renderCauldron() {
  const cauldronEl = document.getElementById('cauldron-area');
  cauldronEl.innerHTML = '';
  if (game.cauldron.length === 0) {
    cauldronEl.innerHTML = '<span class="text-gray-400 text-lg">é‹çˆç©ºç©ºå¦‚ä¹Ÿ...</span>';
  } else {
    game.cauldron.forEach(item => {
      const data = ITEM_DATA[item];
      const div = document.createElement('div');
      div.className = 'cauldron-item';
      div.textContent = `${data.icon} ${item}`;
      cauldronEl.appendChild(div);
    });
  }
}

function checkMaterialsAvailable(ingredients) {
    const required = ingredients.reduce((acc, mat) => {
        acc[mat] = (acc[mat] || 0) + 1;
        return acc;
    }, {});

    for (const mat in required) {
        if ((game.inventory[mat] || 0) < required[mat]) {
            return false;
        }
    }
    return true;
}

function renderRecipes() {
  const rec = document.getElementById('recipes');
  rec.innerHTML = '';
  
  // CR-11: Use the predefined order for recipes display as well
  for (let key of POTION_KEYS_ORDERED) {
    const recipe = ITEM_DATA[key];
								   
    const isKnown = game.knownRecipes.includes(key);
    const ingredients = recipe.ingredients.slice().sort();
    const [mat1, mat2] = ingredients;
    
    const mat1Icon = ITEM_DATA[mat1] ? ITEM_DATA[mat1].icon : '?';
    const mat2Icon = ITEM_DATA[mat2] ? ITEM_DATA[mat2].icon : '?';
    
    const entryDiv = document.createElement('div');
    entryDiv.className = 'recipe-entry';

    let textHtml = `<span class="${isKnown ? 'recipe-known' : 'recipe-unknown'} recipe-text">â€¢ `;
    textHtml += `${mat1Icon} ${mat1} + ${mat2Icon} ${mat2} â†’ `;
    textHtml += `<span class="font-bold">${isKnown ? key : '???'}</span> `;
    
    if (isKnown) {
        //textHtml += `<span class="tier-display tier-${recipe.tier}">T${recipe.tier}</span>`;
        textHtml += ` (${recipe.basePrice}G)`;
    } else {
        //textHtml += `(æœªçŸ¥ T${recipe.tier})`;
    }
    textHtml += `</span>`;
    
    entryDiv.innerHTML += textHtml;
    
    // CR-9: One-click brew button
    if (isKnown) {
        const canBrew = checkMaterialsAvailable(ingredients);
        const btnHtml = `<div class="recipe-action">
            <button onclick="brewFromRecipe('${key}')" ${canBrew ? '' : 'disabled'} title="${canBrew ? 'ä¸€éµåˆæˆ' : 'ç¼ºå°‘ææ–™'}">
                ${canBrew ? 'åˆæˆ' : 'ç¼ºæ–™'}
            </button>
        </div>`;
        entryDiv.innerHTML += btnHtml;
    }

    rec.appendChild(entryDiv);
  }
}

function renderQuest() {
  const questEl = document.getElementById('quest');
  
  // If no quest, try to generate one.
  if (!game.currentQuest) {
    generateQuest();
  }
  
  if (!game.currentQuest) {
     questEl.innerHTML = '<p class="text-gray-500">æš«ç„¡æ–°å§”è¨—ã€‚ä¹Ÿè¨±å¯ä»¥å…ˆè£½ä½œä¸€äº›åº«å­˜ï¼Ÿ</p>';
     return;
  }
  
  const { neededPotion, reward, requestText } = game.currentQuest;
  const potionData = ITEM_DATA[neededPotion];
//  const tierDisplay = `<span class="tier-display tier-${potionData.tier}">T${potionData.tier}</span>`;
  
  const hasPotion = (game.potions[neededPotion] || 0) > 0;

  questEl.innerHTML = `
    <p><strong>${requestText}</strong><br>
    è¦æ±‚ï¼š<span class="font-bold text-red-700">${neededPotion}</span> Ã—1<br>
    å ±é…¬ï¼š<span class="gold text-xl">${reward}</span> G</p>
    <button onclick="completeQuest('${neededPotion}',${reward})" class="mt-2 bg-yellow-500 hover:bg-yellow-600" ${hasPotion ? '' : 'disabled'}>
        âœ¨ äº¤ä»˜å§”è¨— ${hasPotion ? '' : '(ç¼ºå°‘è—¥æ°´)'}
    </button>
  `;
  
  // Display daily event info
  const exploreInfoEl = document.getElementById('explore-info');
  if (game.dailyEvent && game.dailyEvent.type !== 'normal') {
      exploreInfoEl.innerHTML = `<strong>ä»Šæ—¥äº‹ä»¶ï¼š</strong>${game.dailyEvent.description}`;
  } else {
      exploreInfoEl.innerHTML = `ä»Šå¤©é¢¨å¹³æµªéœï¼Œä¸€åˆ‡å¦‚å¸¸ã€‚`;
  }
}

// --- éŠæˆ²é‚è¼¯ ---

function explore(area) {
  if (game.fatigue >= MAX_FATIGUE) {
    addLog("ä½ å·²ç¶“ç´¯å£äº†ï¼ä»Šå¤©ç„¡æ³•å†æ¢ç´¢äº†ã€‚", 'fail');
    return;
  }
  if (game.invCount >= game.maxInventory) { // CR-10: Use maxInventory
    addLog("èƒŒåŒ…å·²æ»¿ï¼å…ˆæ•´ç†ä¸€ä¸‹å†å‡ºç™¼ã€‚", 'fail');
    return;
  }
  
  // ç²å–æ¢ç´¢äº‹ä»¶ä¹˜æ•¸
  let fatigueMultiplier = 1.0;
  let riskMultiplier = 1.0;

  if (game.dailyEvent && game.dailyEvent.type === 'explore_event') {
      fatigueMultiplier = game.dailyEvent.fatigueModifier(area);
      riskMultiplier = game.dailyEvent.riskModifier(area);
  }
  
  // ç–²å‹æ¶ˆè€—
  game.fatigue += 1 * fatigueMultiplier;
  game.fatigue = Math.min(game.fatigue, MAX_FATIGUE);

  const names = {wind: "ç–¾é¢¨è‰åŸ", fire: "çƒˆç„°ç«å±±", water: "æ·±æµ·æ¹–æ³Š", earth: "å¤§åœ°æ£®æ—"};
  const materialNames = materialsByArea[area]; // ç²å–æ‰€æœ‰ææ–™åç¨±

  
  // --- è³‡æºç¨€æœ‰åº¦åŠ æ¬Šé¸æ“‡ (å„ªåŒ–æ–¹æ¡ˆä¿®æ­£) ---
  let selectedItem = null;
  let totalWeight = 0;
  
  // 1. è¨ˆç®—æ¬Šé‡ç¸½å’Œèˆ‡å‰µå»ºåŠ æ¬Šåˆ—è¡¨
  const weightedList = materialNames.map(name => {
      const data = ITEM_DATA[name];
      let weight;
      if (data.tier === 1) weight = 5;
      else if (data.tier === 2) weight = 3;
      else weight = 2; // T3
      
      totalWeight += weight;
      return { name: name, weight: weight };
  });

  // 2. é€²è¡Œéš¨æ©ŸæŠ½å–
  let randWeight = Math.random() * totalWeight;
  let cumulativeWeight = 0;
  
  for (let item of weightedList) {
      cumulativeWeight += item.weight;
      if (randWeight < cumulativeWeight) {
          selectedItem = item.name; // æ­£ç¢ºç²å–ææ–™åç¨± (ç‰©ä»¶éµ)
          break;
      }
  }

  // --- ç–²å‹èˆ‡æ¢ç´¢å¤±æ•—åˆ¤æ–· ---
  let yieldItem = true;
  const baseFailureChance = 0.3;
  const failureChance = baseFailureChance * riskMultiplier;

  if (game.fatigue >= 15 && Math.random() < failureChance) { 
    addLog(`ä½ åœ¨${names[area]}æ„Ÿåˆ°é ­æšˆç›®çœ©ï¼Œä¸€ç„¡æ‰€ç²ã€‚`, 'fail');
    yieldItem = false;
  }
  
  // --- ç²å–é“å…·ä¸¦æ›´æ–°ç‹€æ…‹ ---
  if (yieldItem && selectedItem) {
    game.inventory[selectedItem] = (game.inventory[selectedItem]||0) + 1;
    game.invCount += 1;
    
    // Log story
    const areaStories = exploreStories[area];
    const areaText = areaStories[Math.floor(Math.random()*areaStories.length)];
    const itemStory = ITEM_DATA[selectedItem].story;
    addLog(`ä½ åœ¨${names[area]}æ¢ç´¢ï¼š${areaText} ä½ ç™¼ç¾äº†ã€Œ${ITEM_DATA[selectedItem].icon} ${selectedItem}ã€ï¼(${itemStory})`, 'normal');
  } else if (!yieldItem) {
    // Still costs fatigue but no item found on risk
    addLog(`ä½ åœ¨${names[area]}æ„Ÿåˆ°éå¸¸ç–²æ†Šï¼Œæ²’æœ‰æ¡é›†åˆ°ä»»ä½•æ±è¥¿ã€‚`);
  }
  
  renderGameState();
}
function addToCauldron(item) {
  if (game.cauldron.length >= 2) {
    addLog("é‹å­è£¡å·²ç¶“æœ‰å…©ç¨®ç´ æäº†ï¼è¶•å¿«ç†¬ç…®å§ã€‚", 'fail');
    return;
  }
  
  if (game.inventory[item] > 0) {
    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨æ–¼é‹ä¸­ (ä¸å…è¨±é‡è¤‡æ”¾å…¥åŒä¸€ç´ æ)
    if (game.cauldron.includes(item)) {
        addLog(`ã€Œ${item}ã€å·²ç¶“åœ¨é‹å­è£¡äº†ï¼Œè«‹æ”¾å…¥ä¸åŒçš„ç´ æã€‚`, 'fail');
        return;
    }

    game.inventory[item]--;
    game.invCount--;
    game.cauldron.push(item);
    addLog(`æŠŠã€Œ${ITEM_DATA[item].icon} ${item}ã€è¼•è¼•ä¸Ÿé€²äº†é‹å­â€¦`, 'normal');
    renderGameState();
  } else {
    addLog(`èƒŒåŒ…è£¡æ²’æœ‰ã€Œ${item}ã€äº†ã€‚`, 'fail');
  }
}

function brewFromRecipe(potionKey) { // CR-9: One-click brew logic
    const ingredients = ITEM_DATA[potionKey].ingredients;

    if (game.cauldron.length > 0) {
        addLog("è«‹å…ˆæ¸…ç©ºé‹å­ï¼Œæ‰èƒ½ä½¿ç”¨ä¸€éµåˆæˆã€‚", 'fail');
        return;
    }

    if (!checkMaterialsAvailable(ingredients)) {
        addLog("ç¼ºå°‘é…æ–¹æ‰€éœ€ææ–™ï¼Œç„¡æ³•åˆæˆã€‚", 'fail');
        return;
    }

    // æ‰£é™¤ææ–™
    ingredients.forEach(item => {
        game.inventory[item]--;
        game.invCount--;
        if (game.inventory[item] === 0) {
            delete game.inventory[item];
        }
    });

    // åŸ·è¡Œåˆæˆé‚è¼¯ (ä¸éœ€è¦æ”¾å…¥ cauldronï¼Œç›´æ¥åˆæˆ)
    const successPotion = ITEM_DATA[potionKey];
    
    game.potions[potionKey] = (game.potions[potionKey]||0) + 1;
    
    // [æ–°æ©Ÿåˆ¶] ç™¼ç¾é…æ–¹
    if (!game.knownRecipes.includes(potionKey)) {
      game.knownRecipes.push(potionKey);
      addLog(`âœ¨ **æ­å–œï¼ä½ ç™¼ç¾äº†æ–°é…æ–¹ï¼šã€Œ${potionKey} (T${successPotion.tier})ã€ï¼** (åƒ¹å€¼ ${successPotion.basePrice} G)`, 'success');
    }
    
    addLog(`ğŸ”¥ æˆåŠŸç†¬ç…®ï¼(ä¸€éµåˆæˆ) ${successPotion.brewText} ç²å¾—ã€Œ${potionKey}ã€ï¼`, 'success');
    
    renderGameState();
}

function brew() {
  if (game.cauldron.length === 0) {
    addLog("é‹å­è£¡ä»€éº¼éƒ½æ²’æœ‰ï¼ä½ åˆ°åº•æƒ³ç…®ä»€éº¼ï¼Ÿ", 'fail');
    return;
  }
  if (game.cauldron.length !== 2) {
    addLog("é‹å­è£¡çš„ç´ æä¸æ˜¯å‰›å¥½å…©ç¨®â€¦æ„Ÿè¦ºæœƒçˆ†ç‚¸çš„æ¨£å­ï¼", 'fail');
    return;
  }

  const [a, b] = game.cauldron.slice().sort();
  
  let successPotion = null;
  let potionKey = null;

  // æŸ¥æ‰¾é…æ–¹
  for (const key of POTION_KEYS_ORDERED) {
    const item = ITEM_DATA[key];
								 
    const needed = item.ingredients.slice().sort();
    if (needed[0] === a && needed[1] === b) {
      successPotion = item;
      potionKey = key;
      break;
	   
    }
  }

  if (successPotion) {
    game.potions[potionKey] = (game.potions[potionKey]||0) + 1;
    
    // [æ–°æ©Ÿåˆ¶] ç™¼ç¾é…æ–¹
    if (!game.knownRecipes.includes(potionKey)) {
      game.knownRecipes.push(potionKey);
      addLog(`âœ¨ **æ­å–œï¼ä½ ç™¼ç¾äº†æ–°é…æ–¹ï¼šã€Œ${potionKey}ã€ï¼** (åƒ¹å€¼ ${successPotion.basePrice} G)`, 'success');
    }
    
    addLog(`ğŸ”¥ æˆåŠŸç†¬ç…®ï¼${successPotion.brewText} ç²å¾—ã€Œ${potionKey}ã€ï¼`, 'success');
					  
  } else {
    // å¤±æ•— - æ‡²ç½°
    const failText = brewFail[Math.floor(Math.random()*brewFail.length)];
    game.gold = Math.max(0, game.gold - 5);
    addLog(`ğŸ’¥ ç†¬ç…®å¤±æ•—ï¼${failText} ä½ æµªè²»äº†ç´ æï¼Œé‚„æå¤±äº† 5 Gï¼`, 'fail');
  }
  
  game.cauldron = [];
  renderGameState();
}


function clearCauldron() {
  if (game.cauldron.length === 0) {
    addLog("é‹å­å·²ç¶“ç©ºç©ºçš„å•¦ï½");
  } else {
    // è¿”é‚„æ‰€æœ‰ç´ æåˆ°èƒŒåŒ…
    game.cauldron.forEach(item => {
      if (game.invCount < game.maxInventory) { // Only return if space is available
        game.inventory[item] = (game.inventory[item]||0) + 1;
        game.invCount++;
      } else {
         addLog(`èƒŒåŒ…å·²æ»¿ï¼ç„¡æ³•è¿”é‚„ã€Œ${item}ã€ï¼Œç´ æéºå¤±ã€‚`, 'fail');
      }
    });
    game.cauldron = [];
    addLog("ä½ æŠŠé‹å­è£¡çš„æ±è¥¿å€’äº†å‡ºä¾†ï¼Œç´ æå…¨éƒ¨æ”¾å›èƒŒåŒ…äº†ã€‚", 'normal');
    renderGameState();
  }
}

function sellPotion(potion, price) {
  if ((game.potions[potion]||0) > 0) {
    game.potions[potion]--;
    game.gold += price;
    addLog(`ä½ æˆåŠŸå°‡ 1 ä»½ã€Œ${potion}ã€ä»¥ ${price} G çš„åƒ¹æ ¼è³£çµ¦äº†è·¯äººã€‚`, 'normal');
    renderGameState();
  } else {
    addLog(`ä½ æ²’æœ‰ã€Œ${potion}ã€å¯ä»¥è²©å”®ã€‚`, 'fail');
  }
}

// --- ä»»å‹™èˆ‡ç¶“ç‡Ÿ (å„ªåŒ–ï¼šå‹•æ…‹å ±é…¬èˆ‡æ•…äº‹) ---
function generateQuest() {
  if (game.currentQuest) {
    // renderQuest() æœƒåœ¨ renderGameState() ä¸­è¢«å‘¼å«
    return; 
  }
  
  const potentialQuests = POTION_KEYS_ORDERED; // Use the ordered list
  const neededPotion = potentialQuests[Math.floor(Math.random() * potentialQuests.length)];
  const potionData = ITEM_DATA[neededPotion];
  const questEvent = QUEST_EVENTS[neededPotion];
  
  // è¨ˆç®—å‹•æ…‹å ±é…¬ï¼šåŸºç¤åƒ¹æ ¼ * (1.2 ~ 1.5 æº¢åƒ¹) * äº‹ä»¶ä¹˜æ•¸
  let eventMultiplier = 1.0;
											 
  if (game.dailyEvent && game.dailyEvent.rewardModifier) {
      eventMultiplier = game.dailyEvent.rewardModifier(potionData);
  }
  
  const basePrice = potionData.basePrice;
  const rewardMultiplier = (1.2 + Math.random() * 0.3) * eventMultiplier;
  const reward = Math.round(basePrice * rewardMultiplier / 5) * 5; // Round to nearest 5

  game.currentQuest = {
    neededPotion,
    reward,
    requestText: questEvent.request
  };
  
				
}

function completeQuest(potion, reward) {
  if (!game.currentQuest || game.currentQuest.neededPotion !== potion) {
     addLog("ä»»å‹™ç‹€æ…‹éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†ï¼", 'fail');
     return;
  }
  
  if ((game.potions[potion]||0) > 0) {
    game.potions[potion]--;
    game.gold += reward;
    game.fame += ITEM_DATA[potion].tier; // æ ¹æ“šè—¥æ°´ç¨€æœ‰åº¦å¢åŠ è²æœ›
    
    // éš¨æ©Ÿå°ˆå±¬æˆåŠŸæ•…äº‹
    const successStories = QUEST_EVENTS[potion].success;
    const story = successStories[Math.floor(Math.random() * successStories.length)];
    
    addLog(`âœ¨ å§”è¨—æˆåŠŸï¼ç²å¾— ${reward} Gã€‚${story} (è²æœ› +${ITEM_DATA[potion].tier})`, 'success');
    game.currentQuest = null; // æ¸…é™¤ä»»å‹™ç‹€æ…‹
  } else {
    // å¤±æ•—æ•…äº‹
    const failStory = QUEST_EVENTS[potion].fail;
    addLog(`å“å‘€â€¦ä½ æ²’æœ‰å®¢äººè¦çš„ã€Œ${potion}ã€ã€‚å§”è¨—å¤±æ•—ï¼${failStory}`, 'fail');
    game.currentQuest = null; // æ¸…é™¤ä»»å‹™ç‹€æ…‹
  }
  
  renderGameState();
}

function triggerDailyEvent() {
    // 30% chance to trigger a non-normal event
    const nonNormalEvents = DAILY_EVENTS.filter(e => e.type !== 'normal');
    if (Math.random() < 0.7 && nonNormalEvents.length > 0) {
        // Trigger a random non-normal event
        game.dailyEvent = nonNormalEvents[Math.floor(Math.random() * nonNormalEvents.length)];
    } else {
        // Trigger the normal event
        game.dailyEvent = DAILY_EVENTS.find(e => e.type === 'normal');
    }

    addLog(`ğŸ“¢ ${game.dailyEvent.name}: ${game.dailyEvent.description}`, 'event');
}

function nextDay() {
  game.day++;
  game.fatigue = 0; // æ¯æ—¥é‡ç½®ç–²å‹
  game.currentQuest = null; // æ¸…é™¤èˆŠä»»å‹™ï¼Œç­‰å¾…ç”Ÿæˆæ–°ä»»å‹™
  game.loggedFatigueFull = false; // é‡ç½®ç–²å‹æ—¥èªŒæ——æ¨™ (BUG 1)
  
  triggerDailyEvent(); // æ¯æ—¥äº‹ä»¶

  // æ¯æ—¥é‡‘å¹£æ¶ˆè€—ï¼ˆä¾‹ï¼šç§Ÿé‡‘ï¼‰
  if (game.gold >= 10) {
     game.gold -= 10;
     addLog("ğŸ’¸ æ”¯ä»˜äº†ä»Šæ—¥çš„åº—èˆ–ç§Ÿé‡‘ 10 Gã€‚", 'normal');
  } else {
     addLog("ğŸ’¸ ä»Šå¤©æ²’è³ºä»€éº¼éŒ¢... ä½†ä½ é‚„æ˜¯æ‰¾åˆ°æ–¹æ³•æ”¯ä»˜äº†ç§Ÿé‡‘ã€‚", 'normal');
  }
  
  addLog(newDayStories[Math.floor(Math.random()*newDayStories.length)]);
  
  renderGameState(); // renderGameState calls generateQuest if currentQuest is null
}

// --- åˆå§‹åŒ–èˆ‡è¼‰å…¥ ---
function init() {
  clearLog();
  try {
    const savedGame = localStorage.getItem('potionShopSave');
    if (savedGame) {
      const loadedGame = JSON.parse(savedGame);
      // Ensure all new/missing properties exist after loading
      game = Object.assign(JSON.parse(JSON.stringify(INITIAL_GAME_STATE)), loadedGame);

      // Re-initialize event data structure if needed
																		  
      game.dailyEvent = game.dailyEvent && game.dailyEvent.riskModifier ? game.dailyEvent : DAILY_EVENTS.find(e => e.type === 'normal');
	   
									 
																													   
																										   
      
      // CR-10: Set initial max inventory if old save doesn't have it
      game.maxInventory = game.maxInventory || INITIAL_GAME_STATE.maxInventory; 
      game.inventoryUpgradeLevel = game.inventoryUpgradeLevel || INITIAL_GAME_STATE.inventoryUpgradeLevel;

      addLog("åµæ¸¬åˆ°è‡ªå‹•å­˜æª”ï¼Œå·²è‡ªå‹•è¼‰å…¥é€²åº¦ã€‚", 'normal');
    } else {
      // New Game Setup
      game = JSON.parse(JSON.stringify(INITIAL_GAME_STATE)); // Fallback to clean state
      game.dailyEvent = DAILY_EVENTS.find(e => e.type === 'normal');
      addLog("ä»Šå¤©æ˜¯æ–°é–‹å¼µçš„ä¸€å¤©ï¼Œå¸Œæœ›æœƒæœ‰å†’éšªè€…ä¾†å§”è¨—å§â€¦åŠ æ²¹ï¼", 'success');
    }
  } catch (e) {
    console.error("Failed to load game from localStorage:", e);
    addLog("è¼‰å…¥å­˜æª”æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œå°‡å¾æ–°éŠæˆ²é–‹å§‹ã€‚", 'fail');
    game = JSON.parse(JSON.stringify(INITIAL_GAME_STATE)); // Fallback to clean state
  }
  
  renderGameState();
}

// å•Ÿå‹•éŠæˆ²
window.onload = init;
</script>
</body>
</html>
